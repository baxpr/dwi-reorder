Bootstrap: docker
From: ubuntu:bionic-20191029

%help


%files
  src    /opt

 
%labels
  Maintainer baxter.rogers@vanderbilt.edu


%post
  apt-get update

  apt-get install -y wget

  # Workaround for filename case collision in linux-libc-dev
  # https://stackoverflow.com/questions/15599592/compiling-linux-kernel-error-xt-connmark-h
  # https://superuser.com/questions/1238903/cant-install-linux-libc-dev-in-ubuntu-on-windows
  apt-get install -y binutils xz-utils 
  mkdir pkgtemp && cd pkgtemp
  apt-get download linux-libc-dev
  ar x linux-libc-dev*deb
  tar xJf data.tar.xz
  tar cJf data.tar.xz ./usr
  ar rcs linux-libc-dev*.deb debian-binary control.tar.xz data.tar.xz
  dpkg -i linux-libc-dev*.deb
  cd .. && rm -r pkgtemp
  
  apt-get install -y xvfb                      # for headless fsleyes
  apt-get install -y python3 python3-pip       # everybody needs python
  apt-get install -y ghostscript imagemagick   # for PDF generation
  #apt-get install freeglut3 libsdl1.2debian    # wxpython runtime dependencies  
 
  # Python libraries for assessor code
  pip3 install nibabel pandas

  # wxpython for fsleyes
  #pip3 install -f https://extras.wxpython.org/wxPython4/extras/linux/gtk2/ubuntu-18.04/ 'wxPython==4.0.7.post2'
   
  # FSLeyes via pip
  # https://users.fmrib.ox.ac.uk/~paulmc/fsleyes/userdoc/latest/install.html
  #pip3 install 'fsleyes==0.32.0'
 
 
 
 
 
 # FSLeyes binary
 #fsleyes_tgz=FSLeyes-0.32.0-ubuntu1804.tar.gz
 #cd /opt
 #wget -q https://fsl.fmrib.ox.ac.uk/fsldownloads/fsleyes/${fsleyes_tgz}
 #tar zxf ${fsleyes_tgz}
 #rm ${fsleyes_tgz}
  
#  apt-get install -y zip unzip
    

#  apt-get install -y xvfb ghostscript imagemagick python python-pip
  

  # Get fsleyes via pip. wxpython and pathlib2 are required first
  #   https://github.com/wxWidgets/Phoenix/blob/master/README.rst#prerequisites
  #   https://wxpython.org/pages/downloads/
#  apt-get install -y dpkg-dev build-essential freeglut3-dev libgl1-mesa-dev libglu1-mesa-dev \
#      libgstreamer-plugins-base1.0-dev libgtk-3-dev libjpeg-dev libnotify-dev libpng-dev \
#      libsdl1.2-dev libsdl2-dev libsm-dev libtiff-dev libwebkit2gtk-4.0-dev libxtst-dev
#  pip install -f \
#      https://extras.wxpython.org/wxPython4/extras/linux/gtk3/ubuntu-18.04 wxPython
#  pip install pathlib2 fsleyes

  # Fix imagemagick policy to allow PDF output. See https://usn.ubuntu.com/3785-1/
#  sed -i 's/rights="none" pattern="PDF"/rights="read | write" pattern="PDF"/' \
#    /etc/ImageMagick-6/policy.xml

  # Create input/output directories for binding
  mkdir /INPUTS && mkdir /OUTPUTS


%environment
  PATH="/opt/src:${PATH}"


%runscript
  xvfb_wrapper.sh "$@"
